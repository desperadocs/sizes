

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>SB_MaxEnt.sbmaxent &mdash; sizes 2013-05 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2013-05',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="sizes 2013-05 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">sizes 2013-05 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for SB_MaxEnt.sbmaxent</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">sbmaxent</span>

<span class="sd">Entropy maximization routine as described in the article</span>
<span class="sd">J Skilling and RK Bryan; MNRAS 211 (1984) 111 - 124.</span>
<span class="sd">(&quot;MNRAS&quot;: &quot;Monthly Notices of the Royal Astronomical Society&quot;)</span>

<span class="sd">:license: Copyright (c) 2013, UChicago Argonne, LLC</span>
<span class="sd">:license: This file is distributed subject to a Software License Agreement found</span>
<span class="sd">     in the file LICENSE that is included with this distribution. </span>

<span class="sd">References:</span>

<span class="sd">1. J Skilling and RK Bryan; MON NOT R ASTR SOC 211 (1984) 111 - 124.</span>
<span class="sd">2. JA Potton, GJ Daniell, and BD Rainford; Proc. Workshop</span>
<span class="sd">   Neutron Scattering Data Analysis, Rutherford</span>
<span class="sd">   Appleton Laboratory, UK, 1986; ed. MW Johnson,</span>
<span class="sd">   IOP Conference Series 81 (1986) 81 - 86, Institute</span>
<span class="sd">   of Physics, Bristol, UK.</span>
<span class="sd">3. ID Culverwell and GP Clarke; Ibid. 87 - 96.</span>
<span class="sd">4. JA Potton, GK Daniell, &amp; BD Rainford,</span>
<span class="sd">   J APPL CRYST 21 (1988) 663 - 668.</span>
<span class="sd">5. JA Potton, GJ Daniell, &amp; BD Rainford,</span>
<span class="sd">   J APPL CRYST 21 (1988) 891 - 897.</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-05-22 18:05:57 -0500 (Wed, 22 May 2013) $</span>
<span class="c"># $Author: jemian $</span>
<span class="c"># $Revision: 815 $</span>
<span class="c"># $URL: https://subversion.xray.aps.anl.gov/small_angle/sizes/trunk/src/SB_MaxEnt/sbmaxent.py $</span>
<span class="c"># $Id: sbmaxent.py 815 2013-05-22 23:05:57Z jemian $</span>
<span class="c">########### SVN repository information ###################</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">rst_table</span>


<span class="n">TEST_LIMIT</span>        <span class="o">=</span> <span class="mf">0.05</span>                    <span class="c"># for convergence</span>
<span class="n">CHI_SQR_LIMIT</span>     <span class="o">=</span> <span class="mf">0.01</span>                    <span class="c"># maximum difference in ChiSqr for a solution</span>
<span class="n">SEARCH_DIRECTIONS</span> <span class="o">=</span> <span class="mi">3</span>                       <span class="c"># &lt;10.  This code requires value = 3</span>
<span class="n">SD1</span>               <span class="o">=</span> <span class="n">SEARCH_DIRECTIONS</span><span class="o">+</span><span class="mi">1</span>     <span class="c"># for convenience below</span>
<span class="n">RESET_STRAYS</span>      <span class="o">=</span> <span class="mi">1</span>                       <span class="c"># was 0.001, correction of stray negative values</span>
<span class="n">DISTANCE_LIMIT_FACTOR</span> <span class="o">=</span> <span class="mf">0.1</span>                 <span class="c"># limitation on df to constrain runaways</span>

<span class="n">MAX_MOVE_LOOPS</span>    <span class="o">=</span> <span class="mi">500</span>                     <span class="c"># for no solution in routine: move, </span>
<span class="n">MOVE_PASSES</span>       <span class="o">=</span> <span class="mf">0.001</span>                   <span class="c"># convergence test in routine: move</span>


<span class="c"># chisq = 0.0</span>
<span class="c"># chizer = 0.0</span>
<span class="c"># beta = None</span>
<span class="c"># c1 = None</span>
<span class="c"># c2 = None</span>
<span class="c"># s1 = None</span>
<span class="c"># s2 = None</span>


<div class="viewcode-block" id="MaxEntException"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEntException">[docs]</a><span class="k">class</span> <span class="nc">MaxEntException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;Any exception from this module&#39;&#39;&#39;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="opus"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.opus">[docs]</a><span class="k">def</span> <span class="nf">opus</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    opus: transform solution-space -&gt; data-space:  [G]^tr * image</span>
<span class="sd">    </span>
<span class="sd">    default definition, caller can use this definition or provide an alternative</span>
<span class="sd">    </span>
<span class="sd">    :param float[N] image: solution, ndarray of shape (N)</span>
<span class="sd">    :param float[M][N] G: transformation matrix, ndarray of shape (M,N)</span>
<span class="sd">    :returns float[M]: calculated data, ndarray of shape (M)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">G</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="tropus"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.tropus">[docs]</a><span class="k">def</span> <span class="nf">tropus</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    tropus: transform data-space -&gt; solution-space:  [G] * data</span>
<span class="sd">    </span>
<span class="sd">    default definition, caller can use this definition or provide an alternative</span>
<span class="sd">    </span>
<span class="sd">    :param float[M] data: observations, ndarray of shape (M)</span>
<span class="sd">    :param float[M][N] G: transformation matrix, ndarray of shape (M,N)</span>
<span class="sd">    :returns float[N]: calculated image, ndarray of shape (N)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">G</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="MaxEnt"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt">[docs]</a><span class="k">class</span> <span class="nc">MaxEnt</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;manage the iterative method described by Skilling and Bryan&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">IterMax</span><span class="p">,</span> <span class="n">image_to_data</span><span class="p">,</span> <span class="n">data_to_image</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">datum</span>       <span class="c"># measured data, ndarray of shape (M)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>      <span class="c"># estimated uncertainties of data, ndarray of shape (M)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IterMax</span> <span class="o">=</span> <span class="n">IterMax</span>  <span class="c"># int, maximum number of iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c"># current number of completed iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span>        <span class="c"># default value of solution, ndarray of shape (N)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_to_data</span> <span class="o">=</span> <span class="n">image_to_data</span>  <span class="c"># method reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_to_image</span> <span class="o">=</span> <span class="n">data_to_image</span>  <span class="c"># method reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>              <span class="c"># response matrix, ndarray of shape (M,N)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>      <span class="c"># number of measured data points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>      <span class="c"># number of points in solution (image)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">blank</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="c"># use the average value of base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chizer</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>         <span class="c"># ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chtarg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>         <span class="c"># target value of ChiSqr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>                <span class="c"># starting distribution is base</span>
        
<div class="viewcode-block" id="MaxEnt.sum_f"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt.sum_f">[docs]</a>    <span class="k">def</span> <span class="nf">sum_f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns :math:`\\sum_i{f_i}`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="MaxEnt.standardized_residuals"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt.standardized_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">standardized_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        returns vector :math:`\\vec{z}` of standardized_residuals</span>
<span class="sd">        </span>
<span class="sd">        where:</span>
<span class="sd">        </span>
<span class="sd">        * :math:`\\vec{z} = (\\vec{y} - \\hat{\\vec{y}} / \\vec{\\sigma}`</span>
<span class="sd">        * :math:`\\vec{y}`: measured data (`self.data`)</span>
<span class="sd">        * :math:`\\hat{\\vec{y}} = ` `self.image_to_data(self.f, self.G)`</span>
<span class="sd">        * :math:`\\vec{\\sigma}`: estimated uncertainties of :math:`\\vec{y} (`self.sigma`)`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">y_hat</span><span class="p">)</span> <span class="o">/</span> <span class="n">esd</span>
        </div>
<div class="viewcode-block" id="MaxEnt.chi_squared"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt.chi_squared">[docs]</a>    <span class="k">def</span> <span class="nf">chi_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;returns vector :math:`\\sum{z}`&#39;&#39;&#39;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardized_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="MaxEnt.compute_beta"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt.compute_beta">[docs]</a>    <span class="k">def</span> <span class="nf">compute_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;beta vector: ... meaning ...&#39;&#39;&#39;</span>
        </div>
<div class="viewcode-block" id="MaxEnt.MaxEnt_iteration"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt.MaxEnt_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">MaxEnt_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;one iteration of the MaxEnt algorithm&#39;&#39;&#39;</span>
        <span class="c"># Note that the order of subscripts for</span>
        <span class="c"># &quot;xi&quot; and &quot;eta&quot; has been reversed from</span>
        <span class="c"># the convention used in the FORTRAN version</span>
        <span class="c"># to enable parts of them to be passed as</span>
        <span class="c"># as vectors to &quot;image_to_data&quot; and &quot;data_to_image&quot;.</span>
        <span class="n">xi</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="n">eta</span>     <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">npt</span><span class="p">))</span>
        <span class="n">beta</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>
        <span class="c"># s1      = 0*numpy.ndarray((SEARCH_DIRECTIONS))</span>
        <span class="c"># c1      = 0*numpy.ndarray((SEARCH_DIRECTIONS))</span>
        <span class="n">s2</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>
        <span class="n">c2</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>
        
        <span class="n">fSum</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_f</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardized_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>       <span class="c"># SB eq. 3</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chi_squared</span><span class="p">()</span>                  <span class="c"># SB eq. 4</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span>                    <span class="c"># gradient of Chi^2</span>

        <span class="n">cgrad</span> <span class="o">=</span> <span class="n">data_to_image</span> <span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>          <span class="c"># cgrad[i] = del(C)/del(f[i]), SB eq. 8</span>
        <span class="n">sgrad</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blank</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>  <span class="c"># sgrad[i] = del(S)/del(f[i])</span>
        <span class="n">snorm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sgrad</span><span class="o">*</span><span class="n">sgrad</span><span class="p">))</span>    <span class="c"># entropy term</span>
        <span class="n">cnorm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">cgrad</span><span class="o">*</span><span class="n">cgrad</span><span class="p">))</span>    <span class="c"># ChiSqr term </span>
        <span class="n">tnorm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sgrad</span> <span class="o">*</span> <span class="n">cgrad</span><span class="p">)</span>             <span class="c"># norm for gradient term TEST </span>

</div></div>
<div class="viewcode-block" id="MaxEnt_SB"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEnt_SB">[docs]</a><span class="k">def</span> <span class="nf">MaxEnt_SB</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">IterMax</span><span class="p">,</span> <span class="n">image_to_data</span><span class="p">,</span> <span class="n">data_to_image</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    do the complete Maximum Entropy algorithm of Skilling and Bryan</span>
<span class="sd">    </span>
<span class="sd">    :param float datum[]:</span>
<span class="sd">    :param float sigma[]:</span>
<span class="sd">    :param float base[]:</span>
<span class="sd">    :param int IterMax:</span>
<span class="sd">    :param obj image_to_data: opus function </span>
<span class="sd">    :param obj data_to_image: tropus function</span>
<span class="sd">    :param float[][] G: transformation matrix</span>
<span class="sd">    </span>
<span class="sd">    :returns float[]: f (:math:`f(r) dr`)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">npt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>

    <span class="c"># Note that the order of subscripts for</span>
    <span class="c"># &quot;xi&quot; and &quot;eta&quot; has been reversed from</span>
    <span class="c"># the convention used in the FORTRAN version</span>
    <span class="c"># to enable parts of them to be passed as</span>
    <span class="c"># as vectors to &quot;image_to_data&quot; and &quot;data_to_image&quot;.</span>
    <span class="n">xi</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">eta</span>     <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">npt</span><span class="p">))</span>
    <span class="n">beta</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>
    <span class="c"># s1      = 0*numpy.ndarray((SEARCH_DIRECTIONS))</span>
    <span class="c"># c1      = 0*numpy.ndarray((SEARCH_DIRECTIONS))</span>
    <span class="n">s2</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>
    <span class="n">c2</span>      <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">,</span> <span class="n">SEARCH_DIRECTIONS</span><span class="p">))</span>

    <span class="c"># TODO: replace blank (scalar) with base (vector)</span>
    <span class="n">blank</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>   <span class="c"># use the average value of base</span>

    <span class="n">chizer</span><span class="p">,</span> <span class="n">chtarg</span> <span class="o">=</span> <span class="n">npt</span><span class="o">*</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">npt</span><span class="o">*</span><span class="mf">1.0</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mf">1.0</span>                              <span class="c"># starting distribution is base</span>

    <span class="n">fSum</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                              <span class="c"># find the sum of the f-vector</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">datum</span> <span class="o">-</span> <span class="n">image_to_data</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">G</span><span class="p">))</span> <span class="o">/</span> <span class="n">sigma</span>  <span class="c"># standardized residuals, SB eq. 3</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>                            <span class="c"># Chi^2, SB eq. 4</span>

    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">IterMax</span><span class="p">):</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="n">sigma</span>                        <span class="c"># gradient of Chi^2</span>

        <span class="n">cgrad</span> <span class="o">=</span> <span class="n">data_to_image</span> <span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>              <span class="c"># cgrad[i] = del(C)/del(f[i]), SB eq. 8</span>
        <span class="n">sgrad</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="o">/</span><span class="n">base</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">blank</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>  <span class="c"># sgrad[i] = del(S)/del(f[i])</span>
        <span class="n">snorm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">sgrad</span><span class="o">*</span><span class="n">sgrad</span><span class="p">))</span>    <span class="c"># entropy term</span>
        <span class="n">cnorm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">cgrad</span><span class="o">*</span><span class="n">cgrad</span><span class="p">))</span>    <span class="c"># ChiSqr term </span>
        <span class="n">tnorm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">sgrad</span> <span class="o">*</span> <span class="n">cgrad</span><span class="p">)</span>             <span class="c"># norm for gradient term TEST </span>

        <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cnorm</span>
        <span class="k">if</span> <span class="nb">iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="mf">0.0</span>     <span class="c"># mismatch between entropy and ChiSquared gradients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">tnorm</span><span class="o">/</span><span class="p">(</span><span class="n">snorm</span><span class="o">*</span><span class="n">cnorm</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span> <span class="c"># SB eq. 37?</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">snorm</span> <span class="o">*</span> <span class="n">test</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">*=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">test</span>
        <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">cgrad</span> <span class="o">/</span> <span class="n">cnorm</span>
        <span class="n">xi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">sgrad</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">cgrad</span><span class="p">)</span>

        <span class="n">eta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_to_data</span> <span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">G</span><span class="p">);</span>          <span class="c"># image --&gt; data</span>
        <span class="n">eta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_to_data</span> <span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">G</span><span class="p">);</span>          <span class="c"># image --&gt; data</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="n">eta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_to_image</span> <span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">G</span><span class="p">);</span>              <span class="c"># data --&gt; image</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span>
        <span class="n">eta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_to_data</span> <span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">G</span><span class="p">)</span>           <span class="c"># image --&gt; data</span>
        
<span class="c">#         print_arr(&quot;MaxEnt: eta.transpose()&quot;, eta.transpose())</span>
<span class="c">#         print_arr(&quot;MaxEnt: xi.transpose()&quot;, xi.transpose())</span>

        <span class="c"># prepare the search directions for the conjugate gradient technique</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cgrad</span><span class="p">)</span> <span class="o">/</span> <span class="n">chisq</span>		            <span class="c"># C_mu</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sgrad</span><span class="p">)</span>                          <span class="c"># S_mu</span>
<span class="c">#         print_vec(&quot;MaxEnt: c1&quot;, c1)</span>
<span class="c">#         print_vec(&quot;MaxEnt: s1&quot;, s1)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">c2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">eta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">eta</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">/</span> <span class="n">chisq</span>
                <span class="n">s2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">xi</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">/</span> <span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">blank</span>
<span class="c">#         print_arr(&quot;MaxEnt: c2&quot;, c2)</span>
<span class="c">#         print_arr(&quot;MaxEnt: s2&quot;, s2)</span>

        <span class="c"># reflect across the body diagonal</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)):</span>
            <span class="n">c2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> 		    <span class="c">#  M_(mu,nu)</span>
            <span class="n">s2</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> 		    <span class="c">#  g_(mu,nu)</span>
 
        <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">c1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">c2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">beta</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">chtarg</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">MaxEntMove</span><span class="p">(</span><span class="n">fSum</span><span class="p">,</span> <span class="n">blank</span><span class="p">,</span> <span class="n">chisq</span><span class="p">,</span> <span class="n">chizer</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>

        <span class="n">f_old</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    <span class="c"># preserve the last image</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">xi</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>   <span class="c"># move the image towards the solution</span>
        
        <span class="c"># As mentioned at the top of p.119,</span>
        <span class="c"># need to protect against stray negative values.</span>
        <span class="c"># In this case, set them to RESET_STRAYS * base[i]</span>
        <span class="c">#f = f.clip(RESET_STRAYS * blank, f.max())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RESET_STRAYS</span> <span class="o">*</span> <span class="n">base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">f_old</span>
        <span class="n">fSum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">fChange</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c"># calculate the normalized entropy</span>
        <span class="n">S</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">((</span><span class="n">f</span><span class="o">/</span><span class="n">fSum</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="o">/</span><span class="n">fSum</span><span class="p">))</span>      <span class="c"># normalized entropy, S&amp;B eq. 1</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">datum</span> <span class="o">-</span> <span class="n">image_to_data</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">G</span><span class="p">))</span> <span class="o">/</span> <span class="n">sigma</span>  <span class="c"># standardized residuals</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>                            <span class="c"># report this ChiSq</span>

        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%3d</span><span class="s">/</span><span class="si">%3d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">((</span><span class="nb">iter</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">IterMax</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%5.2lf%%</span><span class="s"> </span><span class="si">%8lg</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chisq</span><span class="o">/</span><span class="n">chtarg</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%12.5lg</span><span class="s"> </span><span class="si">%10.4lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span> <span class="p">(</span><span class="n">chtarg</span><span class="o">/</span><span class="n">npt</span><span class="p">),</span> <span class="n">value</span> <span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%12.6lg</span><span class="s"> </span><span class="si">%8.2lf</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fSum</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">fChange</span><span class="o">/</span><span class="n">fSum</span><span class="p">)</span>

        <span class="c"># See if we have finished our task.</span>
        <span class="c"># do the hardest test first</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">chisq</span><span class="o">/</span><span class="n">chizer</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CHI_SQR_LIMIT</span><span class="p">)</span> <span class="ow">and</span>  <span class="p">(</span><span class="n">test</span> <span class="o">&lt;</span> <span class="n">TEST_LIMIT</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span>     <span class="c"># solution FOUND returns here</span>
    
    <span class="k">return</span> <span class="bp">None</span>              <span class="c"># no solution after IterMax iterations</span>

</div>
<div class="viewcode-block" id="MaxEntMove"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.MaxEntMove">[docs]</a><span class="k">def</span> <span class="nf">MaxEntMove</span><span class="p">(</span><span class="n">fSum</span><span class="p">,</span> <span class="n">blank</span><span class="p">,</span> <span class="n">chisq</span><span class="p">,</span> <span class="n">chizer</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    move beta one step closer towards the solution</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">a_lower</span><span class="p">,</span> <span class="n">a_upper</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span>          <span class="c"># bracket  &quot;a&quot;</span>
    <span class="n">cmin</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">ChiNow</span> <span class="p">(</span><span class="n">a_lower</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="c">#print &quot;MaxEntMove: cmin = %g&quot; % cmin</span>
    <span class="k">if</span> <span class="n">cmin</span><span class="o">*</span><span class="n">chisq</span> <span class="o">&gt;</span> <span class="n">chizer</span><span class="p">:</span>
        <span class="n">ctarg</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">cmin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctarg</span> <span class="o">=</span> <span class="n">chizer</span><span class="o">/</span><span class="n">chisq</span>
    <span class="n">f_lower</span> <span class="o">=</span> <span class="n">cmin</span> <span class="o">-</span> <span class="n">ctarg</span>
    <span class="n">c_upper</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">ChiNow</span> <span class="p">(</span><span class="n">a_upper</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="n">f_upper</span> <span class="o">=</span> <span class="n">c_upper</span> <span class="o">-</span> <span class="n">ctarg</span>

    <span class="n">fx</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">MOVE_PASSES</span>      <span class="c"># just to start off</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MOVE_PASSES</span> <span class="ow">and</span> <span class="n">loop</span> <span class="o">&lt;=</span> <span class="n">MAX_MOVE_LOOPS</span><span class="p">:</span>
        <span class="n">a_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_lower</span> <span class="o">+</span> <span class="n">a_upper</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>           <span class="c"># search by bisection</span>
        <span class="n">c_new</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">ChiNow</span> <span class="p">(</span><span class="n">a_new</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">c_new</span> <span class="o">-</span> <span class="n">ctarg</span>
        <span class="c"># tighten the search range for the next pass</span>
        <span class="k">if</span> <span class="n">f_lower</span><span class="o">*</span><span class="n">fx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a_lower</span><span class="p">,</span> <span class="n">f_lower</span> <span class="o">=</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">fx</span>
        <span class="k">if</span> <span class="n">f_upper</span><span class="o">*</span><span class="n">fx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a_upper</span><span class="p">,</span> <span class="n">f_upper</span> <span class="o">=</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">fx</span>
        <span class="n">loop</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MOVE_PASSES</span> <span class="ow">or</span> <span class="n">loop</span> <span class="o">&gt;</span> <span class="n">MAX_MOVE_LOOPS</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;MaxEntMove: Loop counter = &quot;</span> 
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">MAX_MOVE_LOOPS</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  No convergence in alpha chop&#39;</span>
        <span class="k">raise</span> <span class="n">MaxEntException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">Dist</span> <span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">beta</span><span class="p">);</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">SEARCH_DIRECTIONS</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">DISTANCE_LIMIT_FACTOR</span><span class="o">*</span><span class="n">fSum</span><span class="o">/</span><span class="n">blank</span><span class="p">):</span>        <span class="c"># invoke the distance penalty, SB eq. 17</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span> <span class="p">(</span><span class="n">fSum</span><span class="o">/</span><span class="p">(</span><span class="n">blank</span><span class="o">*</span><span class="n">w</span><span class="p">))</span>
    <span class="n">chtarg</span> <span class="o">=</span> <span class="n">ctarg</span> <span class="o">*</span> <span class="n">chisq</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">chtarg</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">beta</span>

</div>
<div class="viewcode-block" id="Dist"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.Dist">[docs]</a><span class="k">def</span> <span class="nf">Dist</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;measure the distance of this possible solution&#39;&#39;&#39;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">+=</span> <span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">w</span>

</div>
<div class="viewcode-block" id="ChiNow"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.ChiNow">[docs]</a><span class="k">def</span> <span class="nf">ChiNow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ChiNow</span>
<span class="sd">    </span>
<span class="sd">    :returns tuple: (ChiNow computation of ``w``, beta)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">bx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ax</span>
    <span class="n">a</span> <span class="o">=</span>   <span class="n">bx</span> <span class="o">*</span> <span class="n">c2</span>  <span class="o">-</span>  <span class="n">ax</span> <span class="o">*</span> <span class="n">s2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">bx</span> <span class="o">*</span> <span class="n">c1</span>  <span class="o">-</span>  <span class="n">ax</span> <span class="o">*</span> <span class="n">s1</span><span class="p">)</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">ChoSol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SEARCH_DIRECTIONS</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">+=</span> <span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">c2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">beta</span>

</div>
<div class="viewcode-block" id="ChoSol"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.ChoSol">[docs]</a><span class="k">def</span> <span class="nf">ChoSol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ChoSol: ? chop the solution vectors ?</span>
<span class="sd">    </span>
<span class="sd">    :returns: new vector beta</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mi">0</span>
    <span class="n">bl</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mi">0</span>
    
    <span class="c">#print_arr(&quot;ChoSol: a&quot;, a)</span>
    <span class="c">#print_vec(&quot;ChoSol: b&quot;, b)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;ChoSol: a[0][0] = &quot;</span> 
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;  Value must be positive&#39;</span>
        <span class="k">raise</span> <span class="n">MaxEntException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c"># first, compute fl from a</span>
    <span class="c"># note fl is a lower triangular matrix</span>
    <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">fl</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="c">#print &quot;ChoSol: %d %d %d  z = %lg&quot; % ( i, j, k, z)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="c">#print_arr(&quot;ChoSol: fl&quot;, fl)</span>

    <span class="c"># next, compute bl from fl and b</span>
    <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">bl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c">#print &quot;\t&quot;, i, k, z</span>
        <span class="n">bl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="c">#print_vec(&quot;ChoSol: bl&quot;, bl)</span>

    <span class="c"># last, compute beta from bl and fl</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">n</span><span class="p">))</span>
    <span class="n">beta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="n">fl</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c">#print &quot;\t\t&quot;, i, k, &#39;z=&#39;, z</span>
        <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">fl</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="c">#print_vec(&quot;ChoSol: beta&quot;, beta)</span>

    <span class="k">return</span> <span class="n">beta</span>

</div>
<div class="viewcode-block" id="G_term"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.G_term">[docs]</a><span class="k">def</span> <span class="nf">G_term</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">rhosq</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculates the response matrix :math:`G(Q,r)` </span>
<span class="sd">    </span>
<span class="sd">    :param double q: :math:`Q`</span>
<span class="sd">    :param double r: :math:`r`</span>
<span class="sd">    :param double rhosq: :math:`|\\Delta\\rho|^2`, the scattering contrast</span>
<span class="sd">    :returns double: G(Q,r)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">r</span>
    <span class="n">F</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qr</span><span class="p">)</span> <span class="o">-</span> <span class="n">qr</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">qr</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">qr</span><span class="o">*</span><span class="n">qr</span><span class="o">*</span><span class="n">qr</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">F</span><span class="o">*</span><span class="n">F</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">rhosq</span><span class="o">*</span><span class="mf">1e20</span> <span class="o">*</span> <span class="n">V</span> <span class="o">*</span> <span class="n">shape</span>
    <span class="k">return</span> <span class="n">value</span>

</div>
<div class="viewcode-block" id="print_vec"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.print_vec">[docs]</a><span class="k">def</span> <span class="nf">print_vec</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;print the contents of a vector to the console&#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">[ = (&quot;</span> <span class="o">%</span> <span class="n">text</span><span class="p">,</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot; </span><span class="si">%g</span><span class="s">, &quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">s</span><span class="p">,</span>
    <span class="k">print</span> <span class="s">&quot;)&quot;</span>

</div>
<div class="viewcode-block" id="print_arr"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.print_arr">[docs]</a><span class="k">def</span> <span class="nf">print_arr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;print the contents of an array to the console&#39;&#39;&#39;</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">[][] = (&quot;</span> <span class="o">%</span> <span class="n">text</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot; (&quot;</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%g</span><span class="s">, &quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
        <span class="k">print</span> <span class="s">&quot;),&quot;</span>
    <span class="k">print</span> <span class="s">&quot;)&quot;</span>

</div>
<div class="viewcode-block" id="readTextData"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.readTextData">[docs]</a><span class="k">def</span> <span class="nf">readTextData</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return q, I, dI from a 3-column text file&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;file not found: &quot;</span> <span class="o">+</span> <span class="n">test_data_file</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span>         <span class="c"># transpose rows and columns</span>
    <span class="n">q</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">I</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">dI</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span>

</div>
<div class="viewcode-block" id="test_opus_tropus"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.test_opus_tropus">[docs]</a><span class="k">def</span> <span class="nf">test_opus_tropus</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;test routine for Dist()</span>
<span class="sd">    </span>
<span class="sd">    test values are trivial checks</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>      <span class="c"># identity matrix</span>
    <span class="k">print</span> <span class="s">&quot;tropus:&quot;</span><span class="p">,</span> <span class="n">tropus</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">b</span>
    <span class="k">print</span> <span class="s">&quot;opus:&quot;</span><span class="p">,</span> <span class="n">opus</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">R</span><span class="p">),</span> <span class="n">b</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;tropus:&quot;</span><span class="p">,</span> <span class="n">tropus</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="test_Dist"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.test_Dist">[docs]</a><span class="k">def</span> <span class="nf">test_Dist</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;test routine for Dist()</span>
<span class="sd">    </span>
<span class="sd">    test values obtained from C version of sizes program</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">beta</span>    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="mf">0.0287502</span><span class="p">,</span> <span class="mf">0.0705577</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0257728</span><span class="p">))</span>
    <span class="n">s2</span>      <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span> <span class="mi">177480</span><span class="p">,</span> <span class="o">-</span><span class="mi">248889</span><span class="p">),</span> 
                            <span class="p">(</span><span class="mi">177480</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span> <span class="o">-</span><span class="mi">641283</span><span class="p">),</span>  
                            <span class="p">(</span><span class="o">-</span><span class="mi">248889</span><span class="p">,</span> <span class="o">-</span><span class="mi">641283</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e+06</span><span class="p">)</span> <span class="p">))</span>
    <span class="k">print</span> <span class="s">&quot;Dist:&quot;</span><span class="p">,</span> <span class="n">Dist</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="n">beta</span><span class="p">),</span> <span class="mf">5225.79</span>

</div>
<div class="viewcode-block" id="test_ChoSol"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.test_ChoSol">[docs]</a><span class="k">def</span> <span class="nf">test_ChoSol</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;test routine for ChoSol()</span>
<span class="sd">    </span>
<span class="sd">    test values obtained from C version of sizes program</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># test ChoSol()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span> <span class="p">(</span> <span class="mf">89.2816</span><span class="p">,</span> <span class="mf">16.6402</span><span class="p">,</span> <span class="mf">55.369</span><span class="p">,),</span>
                      <span class="p">(</span> <span class="mf">16.6402</span><span class="p">,</span> <span class="mf">42.875</span><span class="p">,</span> <span class="mf">66.8581</span><span class="p">,),</span>
                      <span class="p">(</span> <span class="mf">55.369</span><span class="p">,</span> <span class="mf">66.8581</span><span class="p">,</span> <span class="mf">124.94</span><span class="p">,),</span>
                     <span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="mf">9.72508</span><span class="p">,</span> <span class="mf">1.72601</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.42046</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&quot;ChoSol:&quot;</span><span class="p">,</span> <span class="n">ChoSol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span> <span class="o">-</span><span class="mf">0.076233</span><span class="p">,</span> <span class="mf">0.286152</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.138715</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span> <span class="p">(</span> <span class="mf">1e+06</span><span class="p">,</span> <span class="o">-</span><span class="mi">177480</span><span class="p">,</span> <span class="mi">248889</span><span class="p">,),</span>
                      <span class="p">(</span> <span class="o">-</span><span class="mi">177480</span><span class="p">,</span> <span class="mf">1e+06</span><span class="p">,</span> <span class="mi">641283</span><span class="p">,),</span>
                      <span class="p">(</span> <span class="mi">248889</span><span class="p">,</span> <span class="mi">641283</span><span class="p">,</span> <span class="mf">1e+06</span><span class="p">,),</span>
                     <span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">165268</span><span class="p">,</span> <span class="mi">31304</span><span class="p">,</span> <span class="mf">84048.4</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&quot;ChoSol:&quot;</span><span class="p">,</span> <span class="n">ChoSol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="p">(</span> <span class="mf">0.17638</span><span class="p">,</span> <span class="mf">0.0626079</span><span class="p">,</span>  <span class="mf">6.42578e-17</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="test_ChiNow"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.test_ChiNow">[docs]</a><span class="k">def</span> <span class="nf">test_ChiNow</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;test routine for ChiNow()</span>
<span class="sd">    </span>
<span class="sd">    test values obtained from C version of sizes program</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span> <span class="mf">9.72508</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.72601</span><span class="p">,</span>  <span class="mf">2.42046</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span>
      <span class="p">(</span> <span class="mf">89.2816</span><span class="p">,</span>  <span class="mf">16.6402</span><span class="p">,</span>  <span class="mf">55.369</span><span class="p">,</span> <span class="p">),</span>
      <span class="p">(</span> <span class="mf">16.6402</span><span class="p">,</span>  <span class="mf">42.875</span><span class="p">,</span>  <span class="mf">66.8581</span><span class="p">,</span> <span class="p">),</span>
      <span class="p">(</span> <span class="mf">55.369</span><span class="p">,</span>  <span class="mf">66.8581</span><span class="p">,</span>  <span class="mf">124.94</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">))</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span> <span class="mi">165268</span><span class="p">,</span>  <span class="mi">31304</span><span class="p">,</span>  <span class="mf">84048.4</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span>
      <span class="p">(</span> <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span>  <span class="mi">177480</span><span class="p">,</span>  <span class="o">-</span><span class="mi">248889</span><span class="p">,</span> <span class="p">),</span>
      <span class="p">(</span> <span class="mi">177480</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span>  <span class="o">-</span><span class="mi">641283</span><span class="p">,</span> <span class="p">),</span>
      <span class="p">(</span> <span class="o">-</span><span class="mi">248889</span><span class="p">,</span>  <span class="o">-</span><span class="mi">641283</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">))</span>
    <span class="c"># ChiNow: result=0.214487</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">ChiNow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;ChiNow:&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">0.214487</span>

</div>
<div class="viewcode-block" id="test_MaxEntMove"><a class="viewcode-back" href="../../sbmaxent.html#SB_MaxEnt.sbmaxent.test_MaxEntMove">[docs]</a><span class="k">def</span> <span class="nf">test_MaxEntMove</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;test routine for MaxEntMove()</span>
<span class="sd">    </span>
<span class="sd">    test values obtained from C version of sizes program</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="mf">4038.84</span>
    <span class="n">chizer</span> <span class="o">=</span> <span class="mf">92.0</span>
    <span class="n">fSum</span> <span class="o">=</span> <span class="mf">0.00768981</span>
    <span class="n">blank</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span> <span class="mf">9.72508</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.72601</span><span class="p">,</span>  <span class="mf">2.42046</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span>
          <span class="p">(</span> <span class="mf">89.2816</span><span class="p">,</span>  <span class="mf">16.6402</span><span class="p">,</span>  <span class="mf">55.369</span><span class="p">,</span> <span class="p">),</span>
          <span class="p">(</span> <span class="mf">16.6402</span><span class="p">,</span>  <span class="mf">42.875</span><span class="p">,</span>  <span class="mf">66.8581</span><span class="p">,</span> <span class="p">),</span>
          <span class="p">(</span> <span class="mf">55.369</span><span class="p">,</span>  <span class="mf">66.8581</span><span class="p">,</span>  <span class="mf">124.94</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">))</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">(</span> <span class="mi">165268</span><span class="p">,</span>  <span class="mi">31304</span><span class="p">,</span>  <span class="mf">84048.4</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
          <span class="p">(</span> <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span>  <span class="mi">177480</span><span class="p">,</span>  <span class="o">-</span><span class="mi">248889</span><span class="p">,</span> <span class="p">),</span>
          <span class="p">(</span> <span class="mi">177480</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span>  <span class="o">-</span><span class="mi">641283</span><span class="p">,</span> <span class="p">),</span>
          <span class="p">(</span> <span class="o">-</span><span class="mi">248889</span><span class="p">,</span>  <span class="o">-</span><span class="mi">641283</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1e+06</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">)</span> <span class="p">)</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">chtarg</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">a_new</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">MaxEntMove</span><span class="p">(</span><span class="n">fSum</span><span class="p">,</span> <span class="n">blank</span><span class="p">,</span> <span class="n">chisq</span><span class="p">,</span> <span class="n">chizer</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: w&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mf">5225.79</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: chtarg&quot;</span><span class="p">,</span> <span class="n">chtarg</span><span class="p">,</span> <span class="mf">2452.56</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: loop&quot;</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="mi">482</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: a_new&quot;</span><span class="p">,</span> <span class="n">a_new</span><span class="p">,</span> <span class="mf">3.24249e-05</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: fx&quot;</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.000196529</span>
    <span class="k">print</span> <span class="s">&quot;MaxEntMove: beta&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.0348757</span><span class="p">,</span>  <span class="mf">0.0855907</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.0312639</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">test_MaxEnt_SB</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;MaxEnt_SB: &quot;</span>
    <span class="n">test_data_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">,</span> <span class="s">&#39;test.sas&#39;</span><span class="p">)</span>
    <span class="n">rhosq</span> <span class="o">=</span> <span class="mi">100</span>     <span class="c"># scattering contrast, 10^20 1/cm^-4</span>
    <span class="n">bkg</span>   <span class="o">=</span> <span class="mf">0.1</span>     <span class="c">#   I = I - bkg</span>
    <span class="n">dMin</span><span class="p">,</span> <span class="n">dMax</span><span class="p">,</span> <span class="n">nRadii</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">40</span>
    <span class="n">defaultDistLevel</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
    <span class="n">IterMax</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">errFac</span> <span class="o">=</span> <span class="mf">1.05</span>
    
    <span class="n">r</span>    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dMin</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dMax</span><span class="p">),</span> <span class="n">nRadii</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dr</span>   <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>          <span class="c"># step size</span>
    <span class="n">f_dr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nRadii</span><span class="p">))</span> <span class="o">*</span> <span class="mi">0</span>  <span class="c"># volume fraction histogram</span>
    <span class="n">b</span>    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nRadii</span><span class="p">))</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">defaultDistLevel</span>  <span class="c"># MaxEnt &quot;sky background&quot;</span>
    
    <span class="n">qVec</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">dI</span> <span class="o">=</span> <span class="n">readTextData</span><span class="p">(</span><span class="n">test_data_file</span><span class="p">)</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nRadii</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qVec</span><span class="p">)))</span>
    <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span> <span class="o">*</span> <span class="mf">1e-24</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rVal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">qVal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qVec</span><span class="p">):</span>
            <span class="n">G</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_term</span><span class="p">(</span><span class="n">qVal</span><span class="p">,</span> <span class="n">rVal</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rhosq</span><span class="p">)</span>
    
    <span class="n">f_dr</span> <span class="o">=</span> <span class="n">MaxEnt_SB</span><span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">dI</span><span class="o">*</span><span class="n">errFac</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">IterMax</span><span class="p">,</span> <span class="n">opus</span><span class="p">,</span> <span class="n">tropus</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f_dr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;no solution&quot;</span>
        <span class="k">return</span>
    
    <span class="k">print</span> <span class="s">&quot;solution reached&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">rst_table</span><span class="o">.</span><span class="n">Table</span><span class="p">()</span>
    <span class="n">t</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;dr&#39;</span><span class="p">,</span> <span class="s">&#39;f(r) dr&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">rows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">dr</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">f_dr</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
    <span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">reST</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">tests</span><span class="p">():</span>
    <span class="n">test_opus_tropus</span><span class="p">()</span>
    <span class="n">test_Dist</span><span class="p">()</span>
    <span class="n">test_ChoSol</span><span class="p">()</span>
    <span class="n">test_ChiNow</span><span class="p">()</span>
    <span class="n">test_MaxEntMove</span><span class="p">()</span>
    <span class="n">test_MaxEnt_SB</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tests</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">sizes 2013-05 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Pete R. Jemian.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>